# Track T2: Distribution Channels (v0.1.0)

## Summary

Jevons v0.1.0 release will be distributed through two primary channels:
1. **Homebrew tap** (primary) — formulae auto-generated by GoReleaser
2. **GitHub releases + install script** (secondary) — direct download with validation

This document outlines the distribution architecture, setup prerequisites, and testing strategy.

---

## Distribution Architecture

### 1. Homebrew Tap (Primary Channel)

**Repository:** `giannimassi/homebrew-jevons` (separate from main repo)

**How it works:**
- GoReleaser automatically generates and updates `Formula/jevons.rb` in the tap repository
- Formula file contains platform-specific URLs and SHA256 checksums for each build
- Users install via: `brew install giannimassi/jevons/jevons`

**Prerequisites:**
- Create the Homebrew tap repository: `https://github.com/giannimassi/homebrew-jevons`
- Add `HOMEBREW_TAP_TOKEN` GitHub personal access token to repository secrets
  - Token must have `public_repo` scope
  - GoReleaser uses this token to push formula updates after release

**GoReleaser Configuration:**
```yaml
brews:
  - name: jevons
    repository:
      owner: giannimassi
      name: homebrew-jevons
      token: "{{ .Env.HOMEBREW_TAP_TOKEN }}"
    homepage: "https://github.com/giannimassi/jevons"
    description: "Local AI usage monitor and dashboard"
    test: |
      system "#{bin}/jevons", "doctor"
    install: |
      bin.install "jevons"
```

**Advantages:**
- Standard macOS/Linux installation experience
- Automatic updates via `brew upgrade jevons`
- Formula follows Homebrew best practices
- No user-facing checksum validation (brew handles it)

### 2. GitHub Releases + Install Script (Secondary Channel)

**Asset format:**
```
jevons_v0.1.0_darwin_arm64.tar.gz
jevons_v0.1.0_darwin_amd64.tar.gz
jevons_v0.1.0_linux_arm64.tar.gz
jevons_v0.1.0_linux_amd64.tar.gz
checksums.txt
```

**Install script:** `install.sh` in repository root

**How it works:**
1. User runs: `curl -fsSL https://raw.githubusercontent.com/giannimassi/jevons/main/install.sh | bash`
   - Optionally specifies version: `... | bash -s -- v0.1.0`
2. Script detects platform (macOS vs Linux, arm64 vs amd64)
3. Queries GitHub API to determine latest release (if no version specified)
4. Downloads tarball and `checksums.txt` from GitHub releases
5. Validates checksum using platform-native tools (`shasum` on macOS, `sha256sum` on Linux)
6. Extracts binary and installs to `./bin/jevons`

**Install script design:**

| Aspect | Implementation |
|--------|---|
| **Shebang** | `#!/bin/sh` (POSIX-compatible) |
| **Platform detection** | `uname -s` (OS), `uname -m` (arch) |
| **Architecture mapping** | `arm64`/`aarch64` → `arm64`, `x86_64` → `amd64` |
| **Checksum algorithm** | SHA-256 (computed locally, compared against `checksums.txt`) |
| **Version resolution** | Argument (e.g., `v0.1.0`) or latest via GitHub API |
| **Error handling** | Clear messages for: unsupported platform, download failure, checksum mismatch, missing tools |
| **Install location** | `./bin/jevons` (no `sudo` required) |
| **Dependencies** | `curl`, `tar`, `awk` (standard POSIX utilities) |

**Advantages:**
- Works without Homebrew
- Fine-grained version control (pinnable)
- Transparent checksum validation
- Simple one-liner installation
- Cross-platform (macOS, Linux, and future platforms)

**Disadvantages:**
- Requires shell access
- Manual updates (no auto-upgrade)

---

## Distribution Decision Matrix

| Criterion | Homebrew | Install Script |
|-----------|----------|---|
| **Ease of use** | Excellent | Good (one-liner) |
| **Discoverability** | High (brew search) | Lower (requires knowing URL) |
| **Auto-upgrade** | Yes | No |
| **Cross-platform** | macOS, Linux | macOS, Linux |
| **POSIX-compatible** | N/A | Yes |
| **Checksum validation** | Transparent to user | Explicit |
| **Installation target** | System location | User-chosen (default `./bin`) |
| **Setup complexity** | Pre-release: create tap, token | None |
| **Primary use case** | General users, package managers | Developers, CI/CD, pinned versions |

**Recommendation:** Lead with Homebrew for most users; offer install script as alternative for developers and CI pipelines.

---

## Prerequisites for First Release

### Immediate (before GoReleaser publish)

1. **Create Homebrew tap repository**
   - Repository name: `giannimassi/homebrew-jevons`
   - Template: minimal repo with `.github/workflows/` for tap updates
   - Public repository (required for Homebrew)

2. **Create and store HOMEBREW_TAP_TOKEN**
   - Generate personal access token in GitHub Settings
   - Scopes: `public_repo` (write access to homebrew-jevons)
   - Store in Jevons repo secrets as `HOMEBREW_TAP_TOKEN`

3. **Validate GoReleaser configuration**
   - Run: `goreleaser release --snapshot --clean --skip=publish`
   - Inspect generated archives and checksums
   - Verify formula template

### After First Release

1. **Test Homebrew installation**
   - Run: `brew install giannimassi/jevons/jevons`
   - Verify binary runs and passes health checks

2. **Test install script**
   - On macOS: `./install.sh v0.1.0`
   - On Linux: `./install.sh v0.1.0`
   - Verify checksum validation passes
   - Verify binary installed and runnable

3. **Update documentation**
   - Add Homebrew installation instructions to README
   - Add one-liner to install script section

4. **Publish release notes**
   - Document both installation methods
   - Link to this track document for distribution details

---

## Testing Plan

### Pre-Release Validation (Local)

```bash
# 1. Build and test locally
make build
make test
make vet
make fmt

# 2. Dry-run GoReleaser
make release-dry-run
# Inspect dist/ for:
# - Archives with correct naming
# - checksums.txt present and valid
# - Formula generated correctly

# 3. Validate install script syntax
shellcheck install.sh

# 4. Test install script on target platforms
./install.sh v0.1.0        # macOS/Linux
curl -fsSL ... | bash -s -- v0.1.0  # Via stdin
```

### Post-Release Validation (Staging)

#### Homebrew Formula
```bash
# Clone the tap repo
git clone https://github.com/giannimassi/homebrew-jevons.git

# Validate formula syntax
brew audit Formula/jevons.rb

# Test installation
brew install ./Formula/jevons.rb

# Verify binary
jevons doctor
jevons --version

# Uninstall and cleanup
brew uninstall jevons
```

#### Install Script
```bash
# macOS (Intel)
./install.sh v0.1.0
./bin/jevons doctor

# macOS (ARM)
./install.sh v0.1.0
./bin/jevons doctor

# Linux (x86_64)
./install.sh v0.1.0
./bin/jevons doctor

# Linux (ARM)
./install.sh v0.1.0
./bin/jevons doctor

# Test version pinning
./install.sh v0.1.0  # Pins to 0.1.0
./install.sh         # Latest

# Test error cases
./install.sh v999.0.0           # Non-existent version
# (should fail with clear message)
```

### QA Checklist

- [ ] Homebrew tap repository created and public
- [ ] HOMEBREW_TAP_TOKEN configured in GitHub secrets
- [ ] GoReleaser dry-run produces correct artifacts
- [ ] `install.sh` shellcheck passes
- [ ] `install.sh` is executable (`chmod +x`)
- [ ] Homebrew formula audits without warnings
- [ ] Homebrew installation succeeds and binary runs
- [ ] Install script succeeds on macOS (Intel and ARM)
- [ ] Install script succeeds on Linux (x86_64 and ARM)
- [ ] Install script validates checksums correctly
- [ ] Checksum mismatch is caught and reported
- [ ] Version pinning works via script argument
- [ ] Latest version query (no arg) works
- [ ] Clear error messages for unsupported platforms

---

## Future Enhancements

1. **Additional package managers**
   - APT (Debian/Ubuntu) repository
   - Snap (Linux) channel
   - MacPorts formula

2. **Self-update mechanism**
   - `jevons update` command to upgrade binary in-place
   - Useful for CI/CD and pinned installations

3. **Installation verification**
   - Signed binaries (GPG or code-signing certificates)
   - More robust checksum validation

4. **Distribution metrics**
   - Download counts per platform
   - Installation success rate tracking

---

## References

- GoReleaser Homebrew documentation: https://goreleaser.com/customization/homebrew/
- Homebrew formula syntax: https://docs.brew.sh/Ruby-API
- POSIX shell scripting: https://pubs.opengroup.org/onlinepubs/9699919799/utilities/contents.html
- GitHub API (releases): https://docs.github.com/en/rest/releases/releases

---

## Changelog

- 2026-02-13 — Initial distribution architecture document; `install.sh` and formula template created; GoReleaser configured for Homebrew tap automation
